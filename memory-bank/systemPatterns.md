# System Patterns: Webview Gesture Pad Approach

This document outlines the key architectural decisions, design patterns, and component relationships for the VS Code Gesture Pad extension using the Webview API.

## Architecture Overview

The extension utilizes a two-process architecture inherent to VS Code extensions using Webviews:

1.  **Extension Host Process:**

    - Runs the main `src/extension.js` code.
    - Responsible for registering commands (e.g., `mouseGestures.showGesturePad`).
    - Manages the lifecycle of the Webview panel (`vscode.window.createWebviewPanel`).
    - Listens for messages (`panel.webview.onDidReceiveMessage`) sent from the Webview.
    - Executes VS Code commands (`vscode.commands.executeCommand`) based on received messages.

2.  **Webview Process:**
    - Runs the HTML, CSS, and JavaScript content loaded into the Webview panel.
    - Isolated from the Extension Host.
    - The JavaScript within the Webview is responsible for:
      - Rendering the simple "Gesture Pad" UI.
      - Capturing standard DOM mouse events (`mousedown`, `mousemove`, `mouseup` for left-click drags).
      - Analyzing the mouse movement to detect gestures.
      - Sending messages (`vscode.postMessage()`) back to the Extension Host when a gesture is detected.

## Key Patterns

- **View Contribution (`package.json`):** Uses `contributes.viewsContainers` and `contributes.views` to declare a view container in the Activity Bar and place the `gesturePadView` (of type `webview`) within it.
- **Webview View Provider (`src/extension.js`):** Implements the `vscode.WebviewViewProvider` interface (the `GesturePadViewProvider` class). VS Code calls the `resolveWebviewView` method when the view needs to be rendered.
- **Webview View Lifecycle Management:** The provider pattern handles the creation and disposal of the webview view automatically as the user interacts with the VS Code UI (e.g., opening/closing the sidebar view).
- **Configuration Handling:**
  - Uses `contributes.configuration` in `package.json` to define the `mouseGestures.triggerButton` setting.
  - Reads the setting using `vscode.workspace.getConfiguration` in the provider.
  - Uses `vscode.workspace.onDidChangeConfiguration` to listen for changes.
  - Sends configuration updates to the webview via `postMessage`.
- **DOM Event Handling (within Webview Script):** Standard browser JavaScript `addEventListener` is used within `webview/gesturePad.js` to capture `mousedown`, `mousemove`, `mouseup`, and `message` (for config updates). Logic now checks the configured trigger button.
- **Canvas API (within Webview Script):** Uses the HTML `<canvas>` element and its 2D context (`getContext('2d')`) to draw the user's drag path for visual feedback. Path is cleared shortly after gesture recognition. Line width set to 1px.
- **Message Passing:** Asynchronous communication between the Webview process and the Extension Host process using `vscode.postMessage()` (Webview -> Extension for gestures; Extension -> Webview for config) and `webviewView.webview.onDidReceiveMessage` / `window.addEventListener('message')`.
- **State Management (within Webview Script):** Simple JavaScript variables within `webview/gesturePad.js` track the dragging state (`isDragging`), coordinates (`startX`, `startY`, `currentX`, `currentY`), and the configured `triggerButtonCode`.
- **Gesture Recognition (within Webview Script):** Advanced sequence-based gesture recognition in `webview/gesturePad.js` with:
  - Continuous tracking of movement direction changes during drag
  - Angle-based direction detection using `Math.atan2`
  - Configurable thresholds for noise filtering (`minDirectionChange`, `minVelocity`)
  - Full gesture sequence building (e.g., "LRUDLR")
  - Debouncing to prevent rapid, unintended triggers

## Component Relationships

- `package.json`: Defines the view container (`gesturePadContainer`, `icon`), the webview view (`gesturePadView`), the activation event (`onView:gesturePadView`), and the configuration setting (`contributes.configuration`).
- `src/extension.js` (Extension Host):
  - Contains the `GesturePadViewProvider` class.
  - Registers the provider.
  - Reads configuration and listens for changes.
  - The provider's `resolveWebviewView` method generates the Webview's HTML, sends initial config, and handles incoming gesture messages.
  - The provider's `_handleGesture` method executes VS Code actions.
  - The provider's `_sendConfig` method sends config updates to the webview.
- `webview/gesturePad.js` (Webview Process):
  - Listens for configuration messages from the Extension Host.
  - Contains the logic for capturing mouse events (respecting configured button), drawing the path, detecting gestures, and sending gesture messages back.
- Webview HTML/CSS (Generated by Provider):
  - Defines the basic structure (`<div>`, `<canvas>`) and styling of the Gesture Pad view.

## Critical Implementation Paths

- Correctly defining the view contributions in `package.json`.
- Implementing the `WebviewViewProvider` interface correctly in `src/extension.js`.
- Correctly setting up the webview options (`enableScripts`, `localResourceRoots`) and security (nonces) within `resolveWebviewView`.
- Implementing robust and accurate left-click drag detection logic within `webview/gesturePad.js`.
- Correctly implementing canvas drawing logic (clearing, path drawing, resizing, line width) in `webview/gesturePad.js`.
- Establishing reliable message passing between the Webview and the Extension Host via the provider.
- Mapping detected gestures (messages) to the correct VS Code command execution in the provider.
